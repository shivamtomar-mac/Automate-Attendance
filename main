import time
import datetime
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

class TestTan1():
    def setup_method(self, method):
        self.driver = webdriver.Chrome()
        self.driver.maximize_window()

    def teardown_method(self, method):
        self.driver.quit()

    def select_radio_by_label(self, label_text):
        try:
            # Find all labels with radio buttons
            labels = self.driver.find_elements(By.XPATH, '//label[contains(@class, "form-check-label")]')
            for label in labels:
                if label_text.strip().lower() in label.text.strip().lower():
                    radio = label.find_element(By.TAG_NAME, 'input')
                    radio.click()
                    print(f"✔ Selected: {label_text}")
                    return True
            print("✖ Radio label not found.")
        except Exception as e:
            print("✖ Error selecting radio button:", e)
        return False

    def test_tan1(self):
        driver = self.driver
        current_day = datetime.datetime.now().day
        day_xpath = f'//a[text()="{current_day}"]'

        # 1. Login
        driver.get("http://moodle.mitsgwalior.in/login/index.php")
        time.sleep(2)
        driver.find_element(By.ID, "username").send_keys("your_username_here")
        driver.find_element(By.ID, "password").send_keys("your_password_here")
        driver.find_element(By.ID, "loginbtn").click()
        time.sleep(6)

        # 2. Click on today’s date
        try:
            day_link = driver.find_element(By.XPATH, day_xpath)
            day_link.click()
        except NoSuchElementException:
            print("✖ Today's date link not found.")
            return
        time.sleep(3)

        # 3. Open all course cards
        links = driver.find_elements(By.CLASS_NAME, "card-link")

        for link in links:
            link.click()
            time.sleep(3)

            try:
                attendance_link = driver.find_element(By.LINK_TEXT, "Submit attendance")
                attendance_link.click()
                time.sleep(2)

                # 4. Select "Present" radio option
                if self.select_radio_by_label("Present"):
                    time.sleep(1)
                    # Optional: click Submit if there's a button
                    try:
                        submit_btn = driver.find_element(By.XPATH, '//input[@type="submit" or @value="Save changes"]')
                        submit_btn.click()
                        print("✔ Attendance submitted.")
                    except NoSuchElementException:
                        print("⚠ Submit button not found. Skipping.")
                else:
                    print("⚠ 'Present' radio not found.")

            except NoSuchElementException:
                print("➤ No 'Submit attendance' link. Skipping.")

            # Go back
            driver.execute_script("window.history.go(-1)")
            time.sleep(3)
